# 服务器部署指南

## 1. 环境准备

### 1.1 安装Python依赖

```bash
pip install -r requirements.txt
```

### 1.2 安装中文字体（重要）

服务器需要安装中文字体，否则海报无法显示中文：

**Ubuntu/Debian:**
```bash
apt-get update
apt-get install -y fonts-wqy-microhei fonts-noto-cjk
```

**CentOS/RHEL:**
```bash
yum install -y wqy-microhei-fonts noto-cjk-fonts
```

**验证字体是否安装:**
```bash
fc-list :lang=zh
```

## 2. 配置说明

### 2.1 必需文件

确保以下文件在项目根目录：
- `吉祥号码.xlsx` - 号码数据文件
- `used_numbers.json` - 已使用号码记录（首次运行会自动创建）

### 2.2 微信配置（可选）

创建 `wechat_config.json` 或设置环境变量：

**方式一：配置文件**
```json
{
    "send_type": "public",
    "config": {
        "app_id": "你的app_id",
        "app_secret": "你的app_secret"
    }
}
```

**方式二：环境变量**
```bash
export WECHAT_SEND_TYPE=public
export WECHAT_APP_ID=你的app_id
export WECHAT_APP_SECRET=你的app_secret
```

### 2.3 Web服务配置（可选）

可以通过环境变量配置Web服务：

```bash
export WEB_HOST=0.0.0.0    # 监听地址，默认0.0.0.0
export WEB_PORT=5000       # 监听端口，默认5000
export WEB_DEBUG=False     # 调试模式，默认False
```

### 2.4 OpenAI配置（可选）

如果需要AI生成文案：

```bash
export OPENAI_API_KEY=你的api_key
export OPENAI_MODEL=gpt-4o-mini
```

## 3. 启动方式

### 3.1 Web服务（推荐）

```bash
python web_app.py
```

访问 `http://服务器IP:5000` 即可使用。

### 3.2 定时任务模式

```bash
python main.py --schedule
```

默认每天 09:00、12:00、18:00 自动生成海报，其中12:00和18:00会自动发送到微信。

### 3.3 单次生成

```bash
python main.py --once --send
```

## 4. 目录结构

```
吉祥号/
├── main.py              # 主程序入口
├── web_app.py           # Web应用
├── requirements.txt     # Python依赖
├── 吉祥号码.xlsx        # 号码数据（必需）
├── used_numbers.json    # 已使用号码记录
├── wechat_config.json   # 微信配置（可选）
├── app/                 # 核心模块
├── output/              # 生成的海报输出目录
└── templates/           # Web界面模板
```

## 5. 常见问题

### 5.1 海报生成失败，中文显示为方块

原因：服务器缺少中文字体。

解决：参考 1.2 节安装中文字体。

### 5.2 Web界面无法从外部访问

原因：默认只监听127.0.0.1。

解决：设置环境变量 `WEB_HOST=0.0.0.0`

### 5.3 AI文案生成失败

原因：未配置OpenAI API或网络问题。

解决：配置OPENAI_API_KEY环境变量，或在生成时使用 `--no-ai` 参数（如果支持）。

### 5.4 微信发送失败

原因：微信配置不正确或Token过期。

解决：检查 `wechat_config.json` 配置，或在公众号后台手动发布草稿。

## 6. 生产环境建议

### 6.1 使用systemd服务

创建 `/etc/systemd/system/jiahao.service`:

```ini
[Unit]
Description=吉祥号码海报生成器
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/吉祥号
Environment=WEB_HOST=0.0.0.0
Environment=WEB_PORT=80
ExecStart=/usr/bin/python3 /path/to/吉祥号/web_app.py
Restart=always

[Install]
WantedBy=multi-user.target
```

### 6.2 使用Gunicorn（生产环境推荐）

```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:80 web_app:app
```

### 6.3 使用Nginx反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```
