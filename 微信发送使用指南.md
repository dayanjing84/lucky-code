# 微信自动发送功能使用指南

## 📱 功能说明

系统现已支持将生成的吉祥号码海报自动发送到微信公众号或企业微信,实现真正的"生成即发布"。

### 支持的发送方式

1. **微信公众号** (适合对外宣传)
   - 自动创建图文草稿
   - 需要认证的订阅号或服务号
   - 创建后需手动到公众号后台发布

2. **企业微信** (推荐,更稳定)
   - 直接发送图片到企业微信应用
   - 可发送给全体成员或指定人员
   - 无需手动操作,完全自动化

3. **不发送** (默认)
   - 仅生成图片,不发送到任何平台

## 🔧 配置步骤

### 步骤1: 创建配置文件

复制示例配置文件:
```bash
# Windows
copy wechat_config.example.json wechat_config.json

# Linux/Mac
cp wechat_config.example.json wechat_config.json
```

### 步骤2: 选择发送方式并填写配置

#### 方式A: 使用微信公众号

1. **获取AppID和AppSecret**
   - 登录微信公众平台: https://mp.weixin.qq.com/
   - 进入 `设置与开发 -> 基本配置`
   - 复制 `开发者ID(AppID)` 和 `开发者密码(AppSecret)`

2. **编辑 wechat_config.json**
```json
{
  "send_type": "public",
  "config": {
    "app_id": "wxxxxxxxxxxxxxxxxxxx",
    "app_secret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  }
}
```

3. **注意事项**
   - 必须是**认证过的公众号**
   - 生成的是草稿,需手动到后台发布
   - 适合对外公开宣传

#### 方式B: 使用企业微信 (推荐)

1. **获取企业微信配置**
   - 登录企业微信管理后台: https://work.weixin.qq.com/
   - 进入 `应用管理 -> 自建应用`
   - 创建一个新应用(如"号码推广助手")
   - 记录以下信息:
     - **企业ID**: `我的企业 -> 企业信息 -> 企业ID`
     - **AgentId**: 应用详情页的 `AgentId`
     - **Secret**: 应用详情页的 `Secret`

2. **编辑 wechat_config.json**
```json
{
  "send_type": "work",
  "config": {
    "corp_id": "wwxxxxxxxxxxxxxxxx",
    "agent_id": 1000001,
    "agent_secret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  }
}
```

3. **优点**
   - 完全自动化,无需手动操作
   - 更稳定,不会被封号
   - 适合内部团队使用

#### 方式C: 仅生成图片(不发送)

```json
{
  "send_type": "none",
  "config": {}
}
```

### 步骤3: 验证配置

测试发送功能:
```bash
# 生成一张海报并尝试发送
python main.py --once --send

# 如果看到 "[OK] 微信发送成功" 表示配置正确
```

## 🚀 使用方法

### 1. 手动发送(命令行)

```bash
# 生成海报并发送到微信
python main.py --once --send

# 指定分类并发送
python main.py --once --category "尾号双重" --send

# 调试模式(查看详细日志)
python main.py --once --send --debug
```

### 2. 定时自动发送

启动定时任务后,系统会在**每天12点和18点**自动发送:

```bash
# 启动定时任务
python main.py --schedule
```

定时计划:
- **09:00**: 生成海报(不发送)
- **12:00**: 生成海报 + **自动发送到微信** ✅
- **18:00**: 生成海报 + **自动发送到微信** ✅

### 3. 通过环境变量配置(可选)

除了配置文件,也可以使用环境变量:

**Windows PowerShell:**
```powershell
$env:WECHAT_SEND_TYPE="work"
$env:WECHAT_CORP_ID="wwxxxxxxxxxxxxxxxx"
$env:WECHAT_AGENT_ID="1000001"
$env:WECHAT_AGENT_SECRET="xxxxxx"

python main.py --once --send
```

**Linux/Mac:**
```bash
export WECHAT_SEND_TYPE=work
export WECHAT_CORP_ID=wwxxxxxxxxxxxxxxxx
export WECHAT_AGENT_ID=1000001
export WECHAT_AGENT_SECRET=xxxxxx

python main.py --once --send
```

## 📋 日志说明

成功的发送会显示:
```
[OK] 已生成: output/20251220_1200.jpg
[OK] 微信发送成功
```

如果发送失败:
```
[ERROR] 微信发送异常: 获取access_token失败: {"errcode":40013,"errmsg":"invalid appid"}
```
说明配置有误,请检查AppID/AppSecret等参数。

## ⚠️ 常见问题

### Q1: 公众号提示"没有权限"
**A:** 必须使用认证过的公众号,个人订阅号权限不足。

### Q2: 企业微信收不到消息
**A:**
1. 检查应用是否已添加可见范围(成员)
2. 确认AgentId和Secret是否正确
3. 查看企业微信后台的应用消息记录

### Q3: 如何修改发送时间?
**A:** 修改 [app/config.py](app/config.py:48) 中的 `schedule_plan`,然后在 [main.py](main.py:183) 中调整自动发送时间判断。

### Q4: 能否同时发送到朋友圈?
**A:** 微信官方API不支持直接发送到朋友圈。企业微信可以发到工作群,公众号可以发布文章。

### Q5: 发送失败会影响图片生成吗?
**A:** 不会。发送失败只会记录错误日志,图片仍会正常生成到output目录。

## 🔒 安全建议

1. **不要**将 `wechat_config.json` 提交到Git仓库
2. 将其添加到 `.gitignore`:
   ```
   wechat_config.json
   ```
3. 定期更换Secret密钥
4. 企业微信应用仅开放给必要的成员

## 📞 技术支持

如有问题,可以:
1. 查看微信官方文档:
   - 公众号: https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html
   - 企业微信: https://developer.work.weixin.qq.com/document/path/90665
2. 检查日志输出中的错误信息
3. 使用 `--debug` 参数查看详细调试信息
